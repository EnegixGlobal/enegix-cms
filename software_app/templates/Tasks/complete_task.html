{% extends 'base2.html' %}
{% load static %}

{% block title %}Complete Task - {{ task.task_id }}{% endblock %}

{% block content %}
<div class="ribbon-header d-flex justify-content-between align-items-center px-4 pb-5 mb-3" style="color: black">
  <div class="d-flex align-items-center">
    <i class="fas fa-check-double me-3 fs-2" style="color: #138496;"></i>
    <div class="fw-bold fs-3">Complete Task</div>
  </div>
  <div class="breadcrumb-text text-end">
    <span class="text-black"><i class="fas fa-home me-1"></i>HOME</span>
    <span class="mx-2 text-black">/</span>
    <span class="text-black"><a href="{% url 'my_assigned_tasks' %}" class="text-decoration-none text-black">My Tasks</a></span>
    <span class="mx-2 text-black">/</span>
    <span class="text-black-50">Complete Task</span>
  </div>
</div>

<div class="container-fluid mt-2">
  <div class="row">
    <div class="col-lg-8 offset-lg-2">
      <div class="card shadow-lg mb-4 modern-card">
        <div class="card-header table-title-bar fw-bold text-white">
          <i class="fas fa-clipboard-check me-2"></i>Task Completion Form
        </div>
        <div class="card-body p-4">
          <!-- Task Summary -->
          <div class="task-summary-box mb-4">
            <h5 class="mb-3"><i class="fas fa-info-circle me-2 text-primary"></i>Task Summary</h5>
            <div class="row">
              <div class="col-md-6 mb-2">
                <strong><i class="fas fa-hashtag text-primary me-2"></i>Task ID:</strong> {{ task.task_id }}
              </div>
              <div class="col-md-6 mb-2">
                <strong><i class="fas fa-flag text-primary me-2"></i>Priority:</strong> 
                <span class="text-uppercase">{{ task.get_priority_display }}</span>
              </div>
              <div class="col-md-12 mb-2">
                <strong><i class="fas fa-heading text-primary me-2"></i>Title:</strong> {{ task.task_title }}
              </div>
              <div class="col-md-6 mb-2">
                <strong><i class="fas fa-calendar-check text-primary me-2"></i>Accepted On:</strong> {{ task.accepted_date|date:"d M Y, h:i A" }}
              </div>
              <div class="col-md-6">
                <strong><i class="fas fa-stopwatch text-primary me-2"></i>Time Elapsed:</strong>
                <span class="badge badge-timer timer-display" data-task-id="{{ task.id }}">
                  <i class="fas fa-spinner fa-spin"></i> Loading...
                </span>
              </div>
            </div>
          </div>

          <!-- Completion Form -->
          <form method="POST" enctype="multipart/form-data" id="completeTaskForm">
            {% csrf_token %}

            <!-- Completion Notes -->
            <div class="step-header mb-3">
              <h5 class="text-primary"><i class="fas fa-clipboard-check me-2"></i>Completion Notes</h5>
              <hr class="title-underline">
            </div>

            <div class="mb-4">
              <label class="form-label">
                <i class="fas fa-pen me-2 text-primary"></i>Detailed Completion Report <span class="text-danger">*</span>
              </label>
              <textarea class="form-control modern-input" name="completion_notes" id="completionNotes" 
                        rows="8" required 
                        placeholder="Please provide detailed information about what you did:

1. What tasks were completed?
2. What approach did you use?
3. Any challenges faced?
4. Final outcome/results"></textarea>
              <small class="char-counter">
                <span id="charCount">0</span> / 10 minimum characters (Be detailed!)
              </small>
            </div>

            <!-- File Uploads -->
            <div class="step-header mb-3 mt-4">
              <h5 class="text-primary"><i class="fas fa-paperclip me-2"></i>Upload Completion Files</h5>
              <hr class="title-underline">
            </div>

            <div class="mb-4">
              <label class="form-label">
                <i class="fas fa-upload me-2 text-primary"></i>Attach Files (Optional)
              </label>
              <input type="file" class="form-control modern-input" name="completion_files" 
                     id="completionFiles" multiple 
                     accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.zip">
              <small class="text-muted">
                <i class="fas fa-info-circle me-1"></i>You can upload multiple files (screenshots, documents, reports, etc.)<br>
                Supported: PDF, DOC, DOCX, XLS, XLSX, JPG, PNG, ZIP (Max 10MB per file)
              </small>
              
              <!-- File Preview -->
              <div id="filePreview" class="mt-3"></div>
            </div>

            <!-- Warning Message -->
            <div class="alert alert-warning border-0" style="background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%);">
              <h6 class="mb-2"><i class="fas fa-exclamation-triangle me-2"></i>Important Notice:</h6>
              <ul class="mb-0">
                <li>Once you submit, the task will be marked as completed</li>
                <li>Timer will stop automatically</li>
                <li>You cannot edit after submission</li>
                <li>Please review your notes before submitting</li>
              </ul>
            </div>

            <!-- Submit Buttons -->
            <div class="text-end mt-4 pt-3 border-top">
              <a href="{% url 'view_task_detail' task.id %}" class="btn btn-secondary btn-nav">
                <i class="fas fa-times me-2"></i>Cancel
              </a>
              <button type="submit" class="btn btn-success btn-nav" id="submitBtn" disabled>
                <i class="fas fa-check-circle me-2"></i>Submit & Complete Task
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
  // Live timer update
  const taskId = {{ task.id }};
  const timerElement = $('.timer-display');
  
  function updateTimer() {
    $.ajax({
      url: `/tasks/ajax/timer/${taskId}/`,
      method: 'GET',
      success: function(response) {
        if (response.success) {
          timerElement.html(`<i class="fas fa-clock me-1"></i>${response.hours}h ${response.minutes}m`);
        }
      }
    });
  }
  
  updateTimer();
  setInterval(updateTimer, 1000);

  // Character count and submit button enable
  const notesField = $('#completionNotes');
  const charCountDisplay = $('#charCount');
  const submitBtn = $('#submitBtn');

  notesField.on('input', function() {
    const length = $(this).val().length;
    charCountDisplay.text(length);

    if (length >= 10) {
      submitBtn.prop('disabled', false);
      charCountDisplay.removeClass('text-danger').addClass('text-success');
    } else {
      submitBtn.prop('disabled', true);
      charCountDisplay.removeClass('text-success').addClass('text-danger');
    }
  });

  // File preview
  $('#completionFiles').on('change', function() {
    const files = this.files;
    let preview = '';
    
    if (files.length > 0) {
      preview = '<div class="file-preview-container">';
      preview += '<h6 class="mb-3"><i class="fas fa-file-alt me-2"></i>Selected Files:</h6>';
      preview += '<div class="file-list">';
      
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const fileSize = (file.size / 1024 / 1024).toFixed(2);
        const fileIcon = getFileIcon(file.name);
        
        preview += `
          <div class="file-item">
            <i class="fas ${fileIcon} file-icon"></i>
            <div class="file-info">
              <div class="file-name">${file.name}</div>
              <div class="file-size">${fileSize} MB</div>
            </div>
          </div>
        `;
      }
      
      preview += '</div></div>';
    }
    
    $('#filePreview').html(preview);
  });

  function getFileIcon(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    const icons = {
      'pdf': 'fa-file-pdf text-danger',
      'doc': 'fa-file-word text-primary',
      'docx': 'fa-file-word text-primary',
      'xls': 'fa-file-excel text-success',
      'xlsx': 'fa-file-excel text-success',
      'jpg': 'fa-file-image text-info',
      'jpeg': 'fa-file-image text-info',
      'png': 'fa-file-image text-info',
      'zip': 'fa-file-archive text-warning'
    };
    return icons[ext] || 'fa-file text-secondary';
  }

  // Form submission confirmation
  $('#completeTaskForm').on('submit', function(e) {
    const notes = notesField.val();
    
    if (notes.length < 10) {
      e.preventDefault();
      alert('⚠️ Please provide detailed completion notes (minimum 10 characters)!');
      return false;
    }

    const confirmed = confirm(
      '✅ Are you sure you want to submit this task as completed?\n\n' +
      '⚠️ Timer will stop and you cannot edit after submission!'
    );

    if (!confirmed) {
      e.preventDefault();
      return false;
    }

    submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Submitting...');
    return true;
  });
});
</script>

<style>
  .modern-card {
    border-radius: 15px;
    border: none;
    overflow: hidden;
  }

  .ribbon-header {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  }

  .card-header.table-title-bar {
    background: linear-gradient(135deg, #28a745 0%, #34ce57 100%);
    padding: 20px;
    font-size: 18px;
    border-bottom: 3px solid rgba(255,255,255,0.2);
  }

  .task-summary-box {
    padding: 20px;
    background: linear-gradient(135deg, #e3f5f8 0%, #d1eef4 100%);
    border-radius: 10px;
    border-left: 4px solid #138496;
  }

  .step-header h5 {
    font-weight: 700;
    display: inline-flex;
    align-items: center;
  }

  .title-underline {
    width: 100px;
    height: 3px;
    background: linear-gradient(to right, #138496, #28a745);
    border: none;
    margin-top: 10px;
  }

  .modern-input {
    border: 2px solid #e0e0e0 !important;
    border-radius: 10px;
    padding: 12px 15px;
    transition: all 0.3s ease;
    color: #000;
  }

  .modern-input:focus {
    border-color: #138496 !important;
    background-color: #f0f9fa !important;
    box-shadow: 0 0 0 0.2rem rgba(19, 132, 150, 0.15);
    transform: translateY(-2px);
  }

  .form-label {
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
  }

  .char-counter {
    display: block;
    margin-top: 8px;
    font-weight: 600;
  }

  #charCount {
    font-size: 16px;
  }

  #charCount.text-danger {
    color: #dc3545 !important;
  }

  #charCount.text-success {
    color: #28a745 !important;
  }

  .badge-timer {
    background: linear-gradient(135deg, #138496 0%, #20c9e0 100%);
    color: white;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    padding: 8px 15px;
    border-radius: 20px;
    font-weight: 600;
  }

  /* File Preview */
  .file-preview-container {
    padding: 20px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 10px;
    border: 2px dashed #138496;
  }

  .file-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .file-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 12px 15px;
    background: white;
    border-radius: 8px;
    transition: all 0.3s ease;
  }

  .file-item:hover {
    transform: translateX(5px);
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
  }

  .file-icon {
    font-size: 28px;
  }

  .file-info {
    flex: 1;
  }

  .file-name {
    font-weight: 600;
    color: #333;
    margin-bottom: 3px;
  }

  .file-size {
    font-size: 12px;
    color: #6c757d;
  }

  .btn-nav {
    padding: 12px 30px;
    border-radius: 10px;
    font-weight: 600;
    transition: all 0.3s ease;
    margin: 0 5px;
  }

  .btn-nav:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
  }

  label .text-danger {
    font-weight: normal;
  }
</style>
{% endblock %}