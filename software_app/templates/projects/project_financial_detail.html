{% extends 'base2.html' %}
{% load static %}

{% block title %}Payment History - {{ project.project_id }}{% endblock %}

{% block content %}
<div class="ribbon-header d-flex justify-content-between align-items-center px-4 pb-5 mb-3" style="color: black">
  <div class="d-flex align-items-center">
    <i class="fas fa-history me-3 fs-2" style="color: #0152a4;"></i>
    <div class="fw-bold fs-3">Payment History</div>
  </div>
  <div class="breadcrumb-text text-end">
    <span class="text-black"><i class="fas fa-home me-1"></i>HOME</span>
    <span class="mx-2 text-black">/</span>
    <span class="text-black">Finance</span>
    <span class="mx-2 text-black">/</span>
    <span class="text-black-50">Payment History</span>
  </div>
</div>

<div class="container-fluid mt-2">
  <!-- Project Summary Card -->
  <div class="card shadow-lg mb-4 modern-card">
    <div class="card-header table-title-bar fw-bold text-white d-flex justify-content-between align-items-center">
      <span>
        <i class="fas fa-project-diagram me-2"></i>
        {{ project.project_id }} - {{ project.project_name }}
      </span>
      <div>
        {% if project.amount_pending > 0 %}
        <a href="{% url 'record_client_payment' project.id %}" class="btn btn-success btn-add-new me-2">
          <i class="fas fa-plus-circle me-2"></i>Record New Payment
        </a>
        {% endif %}
        <a href="{% url 'project_detail' project.id %}" class="btn btn-light btn-add-new">
          <i class="fas fa-arrow-left me-2"></i>Back to Project
        </a>
      </div>
    </div>
    <div class="card-body p-4">
      <div class="row">
        <div class="col-md-3">
          <div class="financial-card">
            <i class="fas fa-money-bill-wave text-primary"></i>
            <div class="financial-details">
              <small class="text-muted">Total Project Value</small>
              <h4 class="mb-0">₹{{ project.total_amount|floatformat:2 }}</h4>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="financial-card">
            <i class="fas fa-check-circle text-success"></i>
            <div class="financial-details">
              <small class="text-muted">Amount Received</small>
              <h4 class="mb-0 text-success">₹{{ project.amount_received|floatformat:2 }}</h4>
              <small class="text-muted">{{ payments|length }} payment(s)</small>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="financial-card">
            <i class="fas fa-hourglass-half text-warning"></i>
            <div class="financial-details">
              <small class="text-muted">Amount Pending</small>
              <h4 class="mb-0 text-warning">₹{{ project.amount_pending|floatformat:2 }}</h4>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="financial-card">
            <i class="fas fa-chart-pie text-info"></i>
            <div class="financial-details">
              <small class="text-muted">Payment Status</small>
              <h4 class="mb-0">
                {% if project.payment_status == 'paid' %}
                <span class="badge bg-success">Fully Paid</span>
                {% elif project.payment_status == 'partial' %}
                <span class="badge bg-warning">Partially Paid</span>
                {% else %}
                <span class="badge bg-danger">Unpaid</span>
                {% endif %}
              </h4>
            </div>
          </div>
        </div>
      </div>

      <!-- Progress Bar -->
      <div class="progress-section mt-4">
        <div class="d-flex justify-content-between mb-2">
          <span><strong>Payment Progress</strong></span>
          <span><strong>₹{{ project.amount_received|floatformat:2 }} / ₹{{ project.total_amount|floatformat:2 }} ({% widthratio project.amount_received project.total_amount 100 %}%)</strong></span>
        </div>
        <div class="progress" style="height: 30px;">
          <div class="progress-bar bg-success progress-bar-striped progress-bar-animated" 
              role="progressbar" 
              style="width: {% widthratio project.amount_received project.total_amount 100 %}%"
              aria-valuenow="{% widthratio project.amount_received project.total_amount 100 %}" 
              aria-valuemin="0" 
              aria-valuemax="100">
            {% widthratio project.amount_received project.total_amount 100 %}%
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Payment History Table -->
  <div class="card shadow-lg mb-4 modern-card">
    <div class="card-header table-title-bar fw-bold text-white">
      <i class="fas fa-receipt me-2"></i>Payment Transactions
    </div>
    <div class="card-body p-4">
      <div class="table-responsive">
        <table class="table table-hover modern-table">
          <thead>
            <tr>
              <th><i class="fas fa-hashtag me-2"></i>S.No</th>
              <th><i class="fas fa-id-badge me-2"></i>Payment ID</th>
              <th><i class="fas fa-calendar-alt me-2"></i>Payment Date</th>
              <th><i class="fas fa-rupee-sign me-2"></i>Amount Paid</th>
              <th><i class="fas fa-credit-card me-2"></i>Payment Method</th>
              <th><i class="fas fa-hashtag me-2"></i>Reference</th>
              <th><i class="fas fa-user me-2"></i>Recorded By</th>
              <th><i class="fas fa-comment me-2"></i>Remarks</th>
              <th><i class="fas fa-file me-2"></i>Proof</th>
            </tr>
          </thead>
          <tbody>
            {% for payment in payments %}
            <tr class="table-row-hover">
              <td><span class="serial-number">{{ forloop.counter }}</span></td>
              <td><strong class="payment-id">{{ payment.payment_id }}</strong></td>
              <td>{{ payment.payment_date|date:"d M Y" }}</td>
              <td><strong class="text-success">₹{{ payment.amount_paid|floatformat:2 }}</strong></td>
              <td>
                <span class="badge modern-badge badge-method-{{ payment.payment_method }}">
                  {% if payment.payment_method == 'cash' %}
                  <i class="fas fa-money-bill-alt me-1"></i>Cash
                  {% elif payment.payment_method == 'bank_transfer' %}
                  <i class="fas fa-university me-1"></i>Bank Transfer
                  {% elif payment.payment_method == 'cheque' %}
                  <i class="fas fa-money-check me-1"></i>Cheque
                  {% elif payment.payment_method == 'upi' %}
                  <i class="fas fa-mobile-alt me-1"></i>UPI
                  {% else %}
                  <i class="fas fa-ellipsis-h me-1"></i>Other
                  {% endif %}
                </span>
              </td>
              <td>
                {% if payment.payment_reference %}
                <code>{{ payment.payment_reference }}</code>
                {% else %}
                <span class="text-muted">-</span>
                {% endif %}
              </td>
              <td>
                <div class="recorded-by">
                  <strong>{{ payment.recorded_by_name }}</strong>
                  <small class="text-muted d-block">{{ payment.recorded_by_role|upper }}</small>
                </div>
              </td>
              <td>
                {% if payment.remarks %}
                <span class="remarks-text" data-bs-toggle="tooltip" title="{{ payment.remarks }}">
                  {{ payment.remarks|truncatewords:5 }}
                </span>
                {% else %}
                <span class="text-muted">-</span>
                {% endif %}
              </td>
              <td>
                {% if payment.payment_proof %}
                <a href="{{ payment.payment_proof.url }}" target="_blank" class="btn btn-sm btn-info">
                  <i class="fas fa-download"></i> View
                </a>
                {% else %}
                <span class="text-muted">-</span>
                {% endif %}
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="9" class="text-center text-muted py-5">
                <i class="fas fa-inbox fa-3x mb-3 text-muted"></i>
                <p>No payments recorded yet</p>
                {% if project.amount_pending > 0 %}
                <a href="{% url 'record_client_payment' project.id %}" class="btn btn-success mt-2">
                  <i class="fas fa-plus-circle me-2"></i>Record First Payment
                </a>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
// Enable tooltips
var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
  return new bootstrap.Tooltip(tooltipTriggerEl)
});
</script>

<style>
  .modern-card {
    border-radius: 15px;
    border: none;
    overflow: hidden;
  }

  .ribbon-header {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  }

  .btn-add-new {
    padding: 10px 25px;
    border-radius: 10px;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .btn-add-new:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
  }

  .financial-card {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 20px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    transition: all 0.3s ease;
  }

  .financial-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
  }

  .financial-card i {
    font-size: 32px;
  }

  .financial-details {
    flex: 1;
  }

  .financial-details small {
    display: block;
    margin-bottom: 5px;
  }

  .progress-section {
    padding: 20px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px;
  }

  .progress {
    border-radius: 15px;
    box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
  }

  .modern-table {
    border-collapse: separate;
    border-spacing: 0;
  }

  .modern-table thead tr {
    background: linear-gradient(135deg, #0152a4 0%, #0168cc 100%);
    color: white;
  }

  .modern-table thead th {
    padding: 15px;
    font-weight: 600;
    border: none;
    vertical-align: middle;
  }

  .modern-table tbody td {
    padding: 15px;
    vertical-align: middle;
    border-bottom: 1px solid #e9ecef;
  }

  .table-row-hover {
    transition: all 0.3s ease;
  }

  .table-row-hover:hover {
    background: linear-gradient(135deg, #f8f9ff 0%, #e9ecef 100%);
    transform: scale(1.01);
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
  }

  .serial-number {
    display: inline-block;
    width: 30px;
    height: 30px;
    background: linear-gradient(135deg, #0152a4 0%, #0168cc 100%);
    color: white;
    border-radius: 50%;
    text-align: center;
    line-height: 30px;
    font-weight: bold;
    font-size: 12px;
  }

  .payment-id {
    color: #0152a4;
    font-size: 14px;
  }

  .recorded-by {
    line-height: 1.2;
  }

  .modern-badge {
    padding: 8px 15px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 12px;
    display: inline-flex;
    align-items: center;
  }

  .badge-method-cash {
    background: linear-gradient(135deg, #28a745 0%, #34ce57 100%);
    color: white;
  }

  .badge-method-bank_transfer {
    background: linear-gradient(135deg, #007bff 0%, #0090ff 100%);
    color: white;
  }

  .badge-method-cheque {
    background: linear-gradient(135deg, #6c757d 0%, #868e96 100%);
    color: white;
  }

  .badge-method-upi {
    background: linear-gradient(135deg, #17a2b8 0%, #20c9e0 100%);
    color: white;
  }

  .badge-method-other {
    background: linear-gradient(135deg, #ffc107 0%, #ffcd38 100%);
    color: black;
  }

  .remarks-text {
    cursor: help;
  }
</style>
{% endblock %}