{% extends 'base2.html' %}
{% load static %}

{% block title %}Apply Leave{% endblock %}

{% block content %}
<div class="ribbon-header d-flex justify-content-between align-items-center px-4 pb-5 mb-3" style="color: black">
  <div class="d-flex align-items-center">
    <i class="fas fa-calendar-plus me-3 fs-3"></i>
    <div>
      <div class="fw-bold fs-3">Apply for Leave</div>
      <small class="text-muted">Submit your leave application</small>
    </div>
  </div>
  <div class="breadcrumb-text text-end">
    <span class="text-black">HOME</span>
    <span class="mx-2 text-black">/</span>
    <span class="text-black-50">Apply Leave</span>
  </div>
</div>

<div class="container-fluid">
  <!-- Leave Balance Card -->
  <div class="row mb-4">
    <div class="col-md-12">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <h5 class="card-title mb-3">
            <i class="fas fa-wallet me-2 text-success"></i>Your Leave Balance
          </h5>
          <div class="row text-center">
            <div class="col-md-3">
              <div class="p-3 bg-success bg-opacity-10 rounded border border-success">
                <h2 class="mb-0 text-success">{{ casual_available_this_month }}</h2>
                <small class="text-muted">Casual Leave (This Month)</small>
                <div class="mt-1">
                  <small class="badge bg-success">1 per month</small>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="p-3 bg-info bg-opacity-10 rounded border border-info">
                <h2 class="mb-0 text-info">{{ sick_available }}</h2>
                <small class="text-muted">Sick Leave (Yearly)</small>
                <div class="mt-1">
                  <small class="badge bg-info">6 per year</small>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="p-3 bg-primary bg-opacity-10 rounded border border-primary">
                <h2 class="mb-0 text-primary">{{ casual_available_this_month|add:sick_available }}</h2>
                <small class="text-muted">Total Available Now</small>
                <div class="mt-1">
                  <small class="badge bg-primary">Current Balance</small>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="p-3 bg-warning bg-opacity-10 rounded border border-warning">
                <small class="d-block text-muted fw-bold">Month {{ leave_balance.current_month }}/{{ leave_balance.current_year }}</small>
                <strong class="text-warning fs-5">Policy</strong>
                <small class="d-block text-muted">1 Casual/month + 6 Sick/year</small>
              </div>
            </div>
          </div>
          
          <!-- Policy Info -->
          <div class="alert alert-info mt-3 mb-0">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Leave Policy:</strong>
            <ul class="mb-0 mt-2">
              <li><strong>Casual Leave:</strong> 1 per month (12 total yearly) - Resets every month on 1st</li>
              <li><strong>Sick Leave:</strong> 6 per year - Use anytime, resets on January 1st</li>
              <li><strong>Unpaid/LWP:</strong> If balance exhausted, extra days are unpaid (deducted from salary)</li>
              <li><strong>Holidays:</strong> Sundays and public holidays are NOT counted as leave days</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Leave Application Form -->
  <div class="row">
    <div class="col-md-12">
      <div class="card shadow-lg border-0 rounded-3">
        <div class="card-header table-title-bar text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="fas fa-file-alt me-2"></i>Leave Application Form
          </h5>
          <a href="{% url 'my_leave_applications' %}" class="btn btn-light btn-sm">
            <i class="fas fa-list me-2"></i>My Applications
          </a>
        </div>

        <div class="card-body p-4">
          <form method="POST" enctype="multipart/form-data" id="leaveForm">
            {% csrf_token %}

            <!-- Leave Type -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label fw-bold">
                  <i class="fas fa-list-ul me-2"></i>Leave Type <span class="text-danger">*</span>
                </label>
                <select name="leave_type" class="form-control" required id="leaveType">
                  <option value="">-- Select Leave Type --</option>
                  <option value="casual">Casual Leave Only</option>
                  <option value="sick">Sick Leave Only</option>
                  <option value="combined">Combined Leave (Casual + Sick)</option>
                </select>
                <small class="text-muted">
                  <i class="fas fa-lightbulb"></i> Choose "Combined" to use both leave types together
                </small>
              </div>

              <div class="col-md-3">
                <label class="form-label fw-bold">
                  <i class="fas fa-calendar-day me-2"></i>From Date <span class="text-danger">*</span>
                </label>
                <input type="date" name="from_date" class="form-control" id="fromDate" min="{{ today }}" required>
              </div>

              <div class="col-md-3">
                <label class="form-label fw-bold">
                  <i class="fas fa-calendar-check me-2"></i>To Date <span class="text-danger">*</span>
                </label>
                <input type="date" name="to_date" class="form-control" id="toDate" min="{{ today }}" required>
              </div>
            </div>

            <!-- Combined Leave Distribution (Hidden by default) -->
            <div class="row mb-3 d-none" id="combinedLeaveSection">
              <div class="col-md-12">
                <div class="card border-warning">
                  <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0">
                      <i class="fas fa-chart-pie me-2"></i>Distribute Your Combined Leave
                    </h6>
                  </div>
                  <div class="card-body">
                    <p class="text-muted mb-3">
                      <strong>Total Days Requested:</strong> <span id="totalDaysDisplay">0</span> days<br>
                      <small>Specify how many days from each leave type.</small>
                    </p>
                    <div class="row">
                      <div class="col-md-6">
                        <label class="form-label fw-bold">
                          <i class="fas fa-calendar-check me-2 text-success"></i>Casual Days to Use
                        </label>
                        <input type="number" name="casual_days" class="form-control" id="casualDaysInput" min="0" max="{{ casual_available_this_month }}" step="1" value="0">
                        <small class="text-muted">Available: {{ casual_available_this_month }} day(s) this month</small>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label fw-bold">
                          <i class="fas fa-notes-medical me-2 text-info"></i>Sick Days to Use
                        </label>
                        <input type="number" name="sick_days" class="form-control" id="sickDaysInput" min="0" max="{{ sick_available }}" step="1" value="0">
                        <small class="text-muted">Available: {{ sick_available }} day(s) this year</small>
                      </div>
                    </div>
                    <div id="distributionError" class="alert alert-danger mt-3 d-none">
                      <i class="fas fa-exclamation-triangle me-2"></i>
                      <span id="errorMessage"></span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Total Days Display -->
            <div class="row mb-3">
              <div class="col-md-12">
                <div class="alert alert-info d-none" id="daysInfo">
                  <i class="fas fa-calendar-alt me-2"></i>
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <strong>Working Days Requested:</strong> <span id="totalDays">0</span> days
                      <small class="d-block mt-1">(Sundays and public holidays excluded)</small>
                    </div>
                    <div id="remainingBalance" class="text-end">
                      <strong>Remaining Balance After:</strong> <span id="remainingDays">0</span> days
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Reason -->
            <div class="row mb-3">
              <div class="col-md-12">
                <label class="form-label fw-bold">
                  <i class="fas fa-comment-alt me-2"></i>Reason for Leave <span class="text-danger">*</span>
                </label>
                <textarea name="reason" class="form-control" rows="5" placeholder="Please provide detailed reason for your leave application..." required minlength="20"></textarea>
                <small class="text-muted">
                  <i class="fas fa-exclamation-triangle"></i> Minimum 20 characters required
                </small>
              </div>
            </div>

            <!-- Attachment -->
            <div class="row mb-4">
              <div class="col-md-6">
                <label class="form-label fw-bold">
                  <i class="fas fa-paperclip me-2"></i>Attachment (Optional)
                </label>
                <input type="file" name="attachment" class="form-control" accept=".pdf,.jpg,.jpeg,.png">
                <small class="text-muted">
                  <i class="fas fa-info-circle"></i> For sick leave, medical certificate recommended
                </small>
              </div>
            </div>

            <!-- Important Note -->
            <div class="alert alert-warning">
              <h6 class="alert-heading">
                <i class="fas fa-exclamation-circle me-2"></i>Important Points:
              </h6>
              <ul class="mb-0">
                <li><strong>Casual Leave:</strong> 1 per month ({{ casual_available_this_month }} available this month)</li>
                <li><strong>Sick Leave:</strong> {{ sick_available }} days remaining this year</li>
                <li><strong>Unpaid Leave:</strong> If balance exhausted, extra days will be unpaid (LWP)</li>
                <li>Sundays and public holidays are NOT counted as leave days</li>
                <li>Leave requires HR approval before it's effective</li>
                <li><strong>Attendance:</strong> Auto-marked as 'L' on approval</li>
              </ul>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex justify-content-end gap-2">
              <a href="{% url 'my_leave_applications' %}" class="btn btn-secondary px-4">
                <i class="fas fa-times me-2"></i>Cancel
              </a>
              <button type="submit" class="btn btn-primary px-4">
                <i class="fas fa-paper-plane me-2"></i>Submit Application
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const fromDate = document.getElementById('fromDate');
  const toDate = document.getElementById('toDate');
  const daysInfo = document.getElementById('daysInfo');
  const totalDaysSpan = document.getElementById('totalDays');
  const totalDaysDisplay = document.getElementById('totalDaysDisplay');
  const leaveType = document.getElementById('leaveType');
  const combinedLeaveSection = document.getElementById('combinedLeaveSection');
  const casualDaysInput = document.getElementById('casualDaysInput');
  const sickDaysInput = document.getElementById('sickDaysInput');
  const remainingDaysSpan = document.getElementById('remainingDays');
  const distributionError = document.getElementById('distributionError');
  const errorMessage = document.getElementById('errorMessage');
  
  // Leave balance values - FIXED
  const casualBalance = parseFloat({{ casual_available_this_month }});
  const sickBalance = parseFloat({{ sick_available }});
  const totalBalance = casualBalance + sickBalance;

  // Show/hide combined leave section
  leaveType.addEventListener('change', function() {
    if (this.value === 'combined') {
      combinedLeaveSection.classList.remove('d-none');
      casualDaysInput.required = true;
      sickDaysInput.required = true;
    } else {
      combinedLeaveSection.classList.add('d-none');
      casualDaysInput.required = false;
      sickDaysInput.required = false;
      casualDaysInput.value = 0;
      sickDaysInput.value = 0;
    }
    calculateWorkingDays();
  });

  function calculateWorkingDays() {
    if (!fromDate.value || !toDate.value || !leaveType.value) {
      daysInfo.classList.add('d-none');
      return;
    }

    const start = new Date(fromDate.value);
    const end = new Date(toDate.value);

    if (end < start) {
      alert('To Date must be after From Date');
      toDate.value = '';
      daysInfo.classList.add('d-none');
      return;
    }

    let workingDays = 0;
    let current = new Date(start);

    while (current <= end) {
      // Skip Sundays (day 0)
      if (current.getDay() !== 0) {
        workingDays++;
      }
      current.setDate(current.getDate() + 1);
    }

    totalDaysSpan.textContent = workingDays;
    totalDaysDisplay.textContent = workingDays;
    daysInfo.classList.remove('d-none');
    
    // Calculate remaining balance
    let remaining = 0;
    if (leaveType.value === 'casual') {
      remaining = Math.max(0, casualBalance - workingDays);
      if (workingDays > casualBalance) {
        remainingDaysSpan.parentElement.innerHTML = '<strong class="text-danger">⚠️ ' + (workingDays - casualBalance) + ' days will be UNPAID!</strong>';
      } else {
        remainingDaysSpan.textContent = remaining;
      }
    } else if (leaveType.value === 'sick') {
      remaining = Math.max(0, sickBalance - workingDays);
      if (workingDays > sickBalance) {
        remainingDaysSpan.parentElement.innerHTML = '<strong class="text-danger">⚠️ ' + (workingDays - sickBalance) + ' days will be UNPAID!</strong>';
      } else {
        remainingDaysSpan.textContent = remaining;
      }
    } else if (leaveType.value === 'combined') {
      remaining = Math.max(0, totalBalance - workingDays);
      if (workingDays > totalBalance) {
        remainingDaysSpan.parentElement.innerHTML = '<strong class="text-danger">⚠️ ' + (workingDays - totalBalance) + ' days will be UNPAID!</strong>';
      } else {
        remainingDaysSpan.textContent = remaining;
      }
    }
    
    // Color code (only if not showing unpaid warning)
    if (workingDays <= (leaveType.value === 'casual' ? casualBalance : leaveType.value === 'sick' ? sickBalance : totalBalance)) {
      if (remaining < 0) {
        remainingDaysSpan.className = 'text-danger fw-bold';
      } else if (remaining < 2) {
        remainingDaysSpan.className = 'text-warning fw-bold';
      } else {
        remainingDaysSpan.className = 'text-success fw-bold';
      }
    }
  }

  // Validate combined leave distribution
  function validateDistribution() {
    if (leaveType.value !== 'combined') return true;
    
    const casualDays = parseFloat(casualDaysInput.value) || 0;
    const sickDays = parseFloat(sickDaysInput.value) || 0;
    const totalDays = parseFloat(totalDaysSpan.textContent) || 0;
    
    // Check if sum matches
    if (Math.abs((casualDays + sickDays) - totalDays) > 0.01) {
      errorMessage.textContent = `Total must equal ${totalDays} days. Currently: ${casualDays + sickDays} days`;
      distributionError.classList.remove('d-none');
      return false;
    }
    
    // Check if exceeds balance
    if (casualDays > casualBalance) {
      errorMessage.textContent = `Casual days (${casualDays}) exceeds available balance (${casualBalance}). Extra will be unpaid.`;
      distributionError.classList.remove('d-none');
      return false;
    }
    
    if (sickDays > sickBalance) {
      errorMessage.textContent = `Sick days (${sickDays}) exceeds available balance (${sickBalance}). Extra will be unpaid.`;
      distributionError.classList.remove('d-none');
      return false;
    }
    
    distributionError.classList.add('d-none');
    return true;
  }

  fromDate.addEventListener('change', calculateWorkingDays);
  toDate.addEventListener('change', calculateWorkingDays);
  casualDaysInput.addEventListener('input', validateDistribution);
  sickDaysInput.addEventListener('input', validateDistribution);

  // Set toDate min to fromDate value
  fromDate.addEventListener('change', function() {
    toDate.min = this.value;
  });

  // Form submission validation
  document.getElementById('leaveForm').addEventListener('submit', function(e) {
    if (leaveType.value === 'combined' && !validateDistribution()) {
      e.preventDefault();
      alert('Please correct the leave distribution before submitting!');
      return;
    }
    
    // Warning for unpaid leaves
    const totalDays = parseFloat(totalDaysSpan.textContent) || 0;
    let unpaidDays = 0;
    
    if (leaveType.value === 'casual' && totalDays > casualBalance) {
      unpaidDays = totalDays - casualBalance;
      if (!confirm(`⚠️ WARNING: ${unpaidDays} day(s) will be UNPAID!\n\nYou have ${casualBalance} casual leave available, but requesting ${totalDays} days.\n\nDo you want to continue?`)) {
        e.preventDefault();
        return;
      }
    }
    
    if (leaveType.value === 'sick' && totalDays > sickBalance) {
      unpaidDays = totalDays - sickBalance;
      if (!confirm(`⚠️ WARNING: ${unpaidDays} day(s) will be UNPAID!\n\nYou have ${sickBalance} sick leaves available, but requesting ${totalDays} days.\n\nDo you want to continue?`)) {
        e.preventDefault();
        return;
      }
    }
  });
});
</script>

<style>
.form-control {
  border: 1.5px solid #444 !important;
  box-shadow: none;
}
.form-control:focus {
  border-color: #222 !important;
  background-color: #f8f8f8 !important;
  outline: none;
  box-shadow: 0 0 0 0.15rem rgba(34, 34, 34, 0.25);
}
</style>

{% endblock %}